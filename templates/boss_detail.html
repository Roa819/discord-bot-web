{% extends "base.html" %}

{% block title %}{{ defeat.boss_name if defeat else 'è¨ä¼è©³ç´°' }} - è¨ä¼ #{{ defeat_id }}{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col-12">
        <a href="/" class="btn btn-secondary mb-3">â† å±¥æ­´ã«æˆ»ã‚‹</a>
        <div class="card mb-4">
            <div class="card-body" style="background: #23272e; color: #fff;">
                <h2 class="mb-2" style="font-size: 1.5rem;">
                    {{ defeat.boss_name if defeat else 'Monster' }} VS {{ participants[0].user_name if participants else '???' }} ã® ãƒ¬ã‚¤ãƒ‰ãƒãƒˆãƒ«
                </h2>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <div class="mb-2"><strong>{{ defeat.boss_name if defeat else 'Monster' }} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</strong></div>
                        <div>HP: {{ defeat.boss_hp if defeat and defeat.boss_hp is defined else '?' }}</div>
                        <div>
                            STR: {{ defeat.boss_str if defeat and defeat.boss_str is defined else '?' }} /
                            DEX: {{ defeat.boss_dex if defeat and defeat.boss_dex is defined else '?' }} /
                            AGI: {{ defeat.boss_agi if defeat and defeat.boss_agi is defined else '?' }} /
                            INT: {{ defeat.boss_int if defeat and defeat.boss_int is defined else '?' }} /
                            VIT: {{ defeat.boss_vit if defeat and defeat.boss_vit is defined else '?' }} /
                            LUK: {{ defeat.boss_luk if defeat and defeat.boss_luk is defined else '?' }}
                        </div>
                        {% if defeat and defeat.boss_equipment %}
                        <div class="mt-2">ğŸ”—è£…å‚™: {{ defeat.boss_equipment }}</div>
                        {% endif %}
                        {% if defeat and defeat.boss_str_buff %}
                        <div>STR: {{ defeat.boss_str }} â†’ {{ defeat.boss_str_buff.value }} ({{ defeat.boss_str_buff.percent }}%)</div>
                        {% endif %}
                        {% if defeat and defeat.boss_vit_buff %}
                        <div>VIT: {{ defeat.boss_vit }} â†’ {{ defeat.boss_vit_buff.value }} ({{ defeat.boss_vit_buff.percent }}%)</div>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-2"><strong>ğŸ“œ æˆ¦é—˜ãƒ­ã‚°</strong></div>
                <div style="font-family: 'Courier New', monospace; font-size: 15px; background: #181c22; color: #fff; padding: 12px; border-radius: 6px;">
                    {% if participants and participants[0].last_turn_log %}
                        {% set battle_log = participants[0].last_turn_log|parse_json if participants[0].last_turn_log is string else participants[0].last_turn_log %}
                        {% for action in battle_log %}
                            {% if action.actor == 'player' %}
                                {{ participants[0].user_name }} ã®æ”»æ’ƒ â†’ {{ action.damage }} ãƒ€ãƒ¡ãƒ¼ã‚¸{% if action.is_crit %} âš¡CRITICAL!{% endif %}
                            {% elif action.actor == 'boss' or action.actor == 'enemy' %}
                                {{ defeat.boss_name if defeat else 'Monster' }} ã®æ”»æ’ƒ â†’ {{ action.damage }} ãƒ€ãƒ¡ãƒ¼ã‚¸{% if action.is_crit %} âš¡CRITICAL!{% endif %}
                            {% endif %}
                            {% if action.is_follow or action.is_extra %}
                                <br>ğŸ—¡ï¸è¿½æ’ƒç™ºç”Ÿï¼â†’+{{ action.damage }}ãƒ€ãƒ¡ãƒ¼ã‚¸
                            {% endif %}
                            <br>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">æˆ¦é—˜ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</span>
                    {% endif %}
                </div>
                <div class="mt-3"><strong>ğŸ“Š æˆ¦é—˜çµæœ</strong></div>
                <div>
                    {{ defeat.boss_name if defeat else 'Monster' }} ã®æ”»æ’ƒï¼šåˆè¨ˆ 
                    {% set boss_total = 0 %}
                    {% set player_total = 0 %}
                    {% if participants and participants[0].last_turn_log %}
                        {% set battle_log = participants[0].last_turn_log|parse_json if participants[0].last_turn_log is string else participants[0].last_turn_log %}
                        {% for action in battle_log %}
                            {% if (action.actor == 'boss' or action.actor == 'enemy') and not action.is_miss %}
                                {% set boss_total = boss_total + action.damage %}
                            {% elif action.actor == 'player' and not action.is_miss %}
                                {% set player_total = player_total + action.damage %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {{ boss_total }} ãƒ€ãƒ¡ãƒ¼ã‚¸<br>
                    {{ participants[0].user_name if participants else '???' }} ã®æ”»æ’ƒï¼šåˆè¨ˆ {{ player_total }} ãƒ€ãƒ¡ãƒ¼ã‚¸
                </div>
                <div class="mt-2">{{ participants[0].user_name if participants else '???' }} ã®æ®‹ã‚ŠHP</div>
                <div style="font-family: 'Courier New', monospace; font-size: 1.2em;">
                    {% set hp_bar = '' %}
                    {% set hp_percent = 0 %}
                    {% if participants and participants[0].hp and participants[0].max_hp %}
                        {% set hp_percent = (participants[0].hp / participants[0].max_hp * 10) | round(0, 'floor') %}
                        {% for i in range(0, 10) %}
                            {% if i < hp_percent %}
                                {% set hp_bar = hp_bar + 'ğŸŸ©' %}
                            {% else %}
                                {% set hp_bar = hp_bar + 'ğŸŸ¥' %}
                            {% endif %}
                        {% endfor %}
                        {{ hp_bar }}<br>
                        {{ participants[0].hp }} / {{ participants[0].max_hp }}
                    {% else %}
                        <span class="text-muted">HPæƒ…å ±ãªã—</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info">
                <h5 class="mb-0">ğŸ“œ æˆ¦é—˜å±¥æ­´</h5>
            </div>
            <div class="card-body">
                {% if attack_history %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th class="text-end">ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸</th>
                                <th class="text-end">è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸</th>
                                <th>æˆ¦é—˜æ™‚åˆ»</th>
                                <th style="width: 100px;">è©³ç´°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attack in attack_history %}
                            {% set battle_log = attack.turn_log|parse_json if attack.turn_log is string else attack.turn_log %}
                            {% set ns = namespace(player_total=0, boss_total=0) %}
                            {% if battle_log and battle_log is sequence %}
                                {% for action in battle_log %}
                                    {% if action.actor == 'player' and not action.is_miss %}
                                        {% set ns.player_total = ns.player_total + action.damage %}
                                    {% elif (action.actor == 'boss' or action.actor == 'enemy') and not action.is_miss %}
                                        {% set ns.boss_total = ns.boss_total + action.damage %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><strong>{{ attack.user_name }}</strong></td>
                                <td class="text-end">
                                    <strong class="text-danger">{{ ns.player_total|format_number }}</strong>
                                </td>
                                <td class="text-end">
                                    {% if ns.boss_total > 0 %}
                                        <span class="text-danger">{{ ns.boss_total|format_number }}</span>
                                    {% else %}
                                        <span class="text-muted">0</span>
                                    {% endif %}
                                </td>
                                <td><small>{{ attack.attacked_at|to_jst_short }}</small></td>
                                <td>
                                    {% if battle_log %}
                                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#battleLog{{ loop.index }}" aria-expanded="false">
                                        è©³ç´° â–¼
                                    </button>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if battle_log %}
                            <tr class="collapse" id="battleLog{{ loop.index }}">
                                <td colspan="6" style="background: #f8f9fa; padding: 20px;">
                                    <div class="p-3" style="background: #fff; border-left: 4px solid #0d6efd; border-radius: 4px;">
                                        <h6 class="text-primary mb-3">
                                            {{ attack.user_name }} ã®æˆ¦é—˜ãƒ­ã‚°
                                        </h6>
                                        
                                        <div style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 2;">
                                            {% for action in battle_log %}
                                                {% if action.actor == 'player' %}
                                                <div style="color: #0d6efd; padding: 4px 0;">
                                                    âš”ï¸ {{ attack.user_name }} ã®æ”»æ’ƒ
                                                    {% if action.is_miss %}
                                                        â†’ <span style="color: #6c757d; font-weight: bold;">Miss!</span>
                                                    {% else %}
                                                        â†’ <span style="color: #dc3545; font-weight: bold;">{{ action.damage }}</span> ãƒ€ãƒ¡ãƒ¼ã‚¸
                                                        {% if action.is_crit %}<span style="color: #ffc107; font-weight: bold;"> â­ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼</span>{% endif %}
                                                    {% endif %}
                                                </div>
                                                {% elif action.actor == 'boss' or action.actor == 'enemy' %}
                                                <div style="color: #dc3545; padding: 4px 0; padding-left: 20px;">
                                                    ğŸ”¥ {{ defeat.boss_name }} ã®æ”»æ’ƒ
                                                    {% if action.is_miss %}
                                                        â†’ <span style="color: #6c757d; font-weight: bold;">Miss!</span>
                                                    {% else %}
                                                        â†’ <span style="color: #dc3545; font-weight: bold;">{{ action.damage }}</span> ãƒ€ãƒ¡ãƒ¼ã‚¸
                                                        {% if action.is_crit %}<span style="color: #ffc107; font-weight: bold;"> â­ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼</span>{% endif %}
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        
                                        <hr class="my-3">
                                        
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <strong class="text-primary">ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong>
                                                <span class="text-danger fs-5">{{ ns.player_total|format_number }}</span>
                                            </div>
                                            <div class="col-6">
                                                <strong class="text-danger">è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong>
                                                <span class="text-dark fs-5">{{ ns.boss_total|format_number }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% elif participants %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th class="text-end">ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸</th>
                                <th class="text-end">è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸</th>
                                <th>æˆ¦é—˜æ™‚åˆ»</th>
                                <th style="width: 100px;">è©³ç´°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in participants %}
                            {% set battle_log = participant.last_turn_log|parse_json if participant.last_turn_log is string else participant.last_turn_log %}
                            {% if battle_log and battle_log is sequence %}
                                {% set ns = namespace(player_total=0, boss_total=0) %}
                                {% for action in battle_log %}
                                    {% if action.actor == 'player' and not action.is_miss %}
                                        {% set ns.player_total = ns.player_total + action.damage %}
                                    {% elif (action.actor == 'boss' or action.actor == 'enemy') and not action.is_miss %}
                                        {% set ns.boss_total = ns.boss_total + action.damage %}
                                    {% endif %}
                                {% endfor %}
                                
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><strong>{{ participant.user_name }}</strong></td>
                                    <td class="text-end">
                                        <strong class="text-danger">{{ ns.player_total|format_number }}</strong>
                                    </td>
                                    <td class="text-end">
                                        {% if ns.boss_total > 0 %}
                                            <span class="text-danger">{{ ns.boss_total|format_number }}</span>
                                        {% else %}
                                            <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ participant.first_attack_at|to_jst_short }}</small></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#battleLog{{ loop.index }}" aria-expanded="false">
                                            è©³ç´° â–¼
                                        </button>
                                    </td>
                                </tr>
                                <tr class="collapse" id="battleLog{{ loop.index }}">
                                    <td colspan="6" style="background: #f8f9fa; padding: 20px;">
                                        <div class="p-3" style="background: #fff; border-left: 4px solid #0d6efd; border-radius: 4px;">
                                            <h6 class="text-primary mb-3">
                                                {{ participant.user_name }} ã®æˆ¦é—˜ãƒ­ã‚°
                                            </h6>
                                            
                                            <div style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 2;">
                                                {% for action in battle_log %}
                                                    {% if action.actor == 'player' %}
                                                    <div style="color: #0d6efd; padding: 4px 0;">
                                                        âš”ï¸ {{ participant.user_name }} ã®æ”»æ’ƒ
                                                        {% if action.is_miss %}
                                                            â†’ <span style="color: #6c757d; font-weight: bold;">Miss!</span>
                                                        {% else %}
                                                            â†’ <span style="color: #dc3545; font-weight: bold;">{{ action.damage }}</span> ãƒ€ãƒ¡ãƒ¼ã‚¸
                                                            {% if action.is_crit %}<span style="color: #ffc107; font-weight: bold;"> â­ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼</span>{% endif %}
                                                               {% if action.is_follow or action.is_extra %}<span style="color: #20c997; font-weight: bold;">ï¼ˆè¿½æ’ƒï¼‰</span>{% endif %}
                                                        {% endif %}
                                                    </div>
                                                    {% elif action.actor == 'boss' or action.actor == 'enemy' %}
                                                    <div style="color: #dc3545; padding: 4px 0; padding-left: 20px;">
                                                        ğŸ”¥ {{ defeat.boss_name }} ã®æ”»æ’ƒ
                                                        {% if action.is_miss %}
                                                            â†’ <span style="color: #6c757d; font-weight: bold;">Miss!</span>
                                                        {% else %}
                                                            â†’ <span style="color: #dc3545; font-weight: bold;">{{ action.damage }}</span> ãƒ€ãƒ¡ãƒ¼ã‚¸
                                                            {% if action.is_crit %}<span style="color: #ffc107; font-weight: bold;"> â­ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼</span>{% endif %}
                                                               {% if action.is_follow or action.is_extra %}<span style="color: #20c997; font-weight: bold;">ï¼ˆè¿½æ’ƒï¼‰</span>{% endif %}
                                                        {% endif %}
                                                    </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            
                                            <hr class="my-3">
                                            
                                            <div class="row text-center">
                                                <div class="col-6">
                                                    <strong class="text-primary">ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong>
                                                    <span class="text-danger fs-5">{{ ns.player_total|format_number }}</span>
                                                </div>
                                                <div class="col-6">
                                                    <strong class="text-danger">è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong>
                                                    <span class="text-dark fs-5">{{ ns.boss_total|format_number }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">å‚åŠ è€…æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
