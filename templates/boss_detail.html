{% extends "base.html" %}

{% block title %}{{ defeat.boss_name if defeat else 'è¨ä¼è©³ç´°' }} - è¨ä¼ #{{ defeat_id }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <a href="/" class="btn btn-secondary mb-3">â† å±¥æ­´ã«æˆ»ã‚‹</a>
        <h1 class="mb-3 text-white">
            {% if defeat %}
                {{ defeat.boss_name }} - è¨ä¼ #{{ defeat.id }}
            {% else %}
                è¨ä¼è©³ç´°
            {% endif %}
        </h1>
    </div>
</div>

{% if defeat %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ãƒœã‚¹æƒ…å ±</h5>
            </div>
            <div class="card-body">
                <p><strong>ãƒœã‚¹å:</strong> {{ defeat.boss_name }}</p>
                <p><strong>æœ€å¤§HP:</strong> {{ defeat.boss_max_hp|int|format_number }}</p>
                
                <div class="alert alert-success mb-0">
                    <strong>âœ… è¨ä¼å®Œäº†</strong><br>
                    <small>{{ defeat.defeated_at|to_jst }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">å‚åŠ çµ±è¨ˆ</h5>
            </div>
            <div class="card-body">
                <p><strong>å‚åŠ è€…æ•°:</strong> {{ defeat.total_participants }} äºº</p>
                <p><strong>ç·ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong> {{ defeat.total_damage|int|format_number }}</p>
                
                {% if participants %}
                <hr>
                <p class="mb-1"><strong>MVP:</strong></p>
                <p class="mb-0">
                    <strong>{{ participants[0].user_name }}</strong><br>
                    <span class="text-danger fs-4">{{ participants[0].total_damage|format_number }}</span> ãƒ€ãƒ¡ãƒ¼ã‚¸
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info">
                <h5 class="mb-0">ğŸ“œ æˆ¦é—˜å±¥æ­´</h5>
            </div>
            <div class="card-body">
                {% if participants %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th class="text-end">åˆè¨ˆãƒ€ãƒ¡ãƒ¼ã‚¸</th>
                                <th class="text-end">æ”»æ’ƒå›æ•°</th>
                                <th>æˆ¦é—˜æ™‚åˆ»</th>
                                <th style="width: 100px;">è©³ç´°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in participants %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><strong>{{ participant.user_name }}</strong></td>
                                <td class="text-end">
                                    <strong class="text-danger">{{ participant.total_damage|format_number }}</strong>
                                </td>
                                <td class="text-end">{{ participant.action_count }}</td>
                                <td><small>{{ participant.first_attack_at|to_jst_short }}</small></td>
                                <td>
                                    {% if participant.last_turn_log %}
                                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#battleLog{{ loop.index }}" aria-expanded="false">
                                        è©³ç´° â–¼
                                    </button>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if participant.last_turn_log %}
                            <tr class="collapse" id="battleLog{{ loop.index }}">
                                <td colspan="6" style="background: #f8f9fa; padding: 20px;">
                                    {% set battle_log = participant.last_turn_log|parse_json if participant.last_turn_log is string else participant.last_turn_log %}
                                    
                                    <div class="p-3" style="background: #fff; border-left: 4px solid #0d6efd; border-radius: 4px;">
                                        <h6 class="text-primary mb-3">
                                            <i class="bi bi-journal-text"></i> {{ participant.user_name }} ã®æˆ¦é—˜ãƒ­ã‚°
                                        </h6>
                                        
                                        {% if battle_log and battle_log is sequence and battle_log is not string %}
                                        <div style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 2;">
                                            {% for action in battle_log %}
                                                {% if action.actor == 'player' %}
                                                <div style="color: #0d6efd; padding: 4px 0;">
                                                    âš”ï¸ {{ participant.user_name }} ã®æ”»æ’ƒ
                                                    {% if action.is_miss %}
                                                        â†’ <span style="color: #6c757d; font-weight: bold;">Miss!</span>
                                                    {% else %}
                                                        â†’ <span style="color: #dc3545; font-weight: bold;">{{ action.damage }}</span> ãƒ€ãƒ¡ãƒ¼ã‚¸
                                                        {% if action.is_crit %}<span style="color: #ffc107; font-weight: bold;"> â­ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼</span>{% endif %}
                                                    {% endif %}
                                                </div>
                                                {% elif action.actor == 'boss' or action.actor == 'enemy' %}
                                                <div style="color: #dc3545; padding: 4px 0; padding-left: 20px;">
                                                    ğŸ”¥ {{ defeat.boss_name }} ã®æ”»æ’ƒ
                                                    {% if action.is_miss %}
                                                        â†’ <span style="color: #6c757d; font-weight: bold;">Miss!</span>
                                                    {% else %}
                                                        â†’ <span style="color: #dc3545; font-weight: bold;">{{ action.damage }}</span> ãƒ€ãƒ¡ãƒ¼ã‚¸
                                                        {% if action.is_crit %}<span style="color: #ffc107; font-weight: bold;"> â­ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼</span>{% endif %}
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        
                                        <hr class="my-3">
                                        
                                        {% set ns = namespace(player_dmg=0, boss_dmg=0) %}
                                        {% for action in battle_log %}
                                            {% if action.actor == 'player' and not action.is_miss %}
                                                {% set ns.player_dmg = ns.player_dmg + action.damage %}
                                            {% elif (action.actor == 'boss' or action.actor == 'enemy') and not action.is_miss %}
                                                {% set ns.boss_dmg = ns.boss_dmg + action.damage %}
                                            {% endif %}
                                        {% endfor %}
                                        
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <strong class="text-primary">ä¸ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong>
                                                <span class="text-danger fs-5">{{ ns.player_dmg|format_number }}</span>
                                            </div>
                                            <div class="col-6">
                                                <strong class="text-danger">è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong>
                                                <span class="text-dark fs-5">{{ ns.boss_dmg|format_number }}</span>
                                            </div>
                                        </div>
                                        {% else %}
                                        <p class="text-muted mb-0">æˆ¦é—˜ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">å‚åŠ è€…æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
