{% extends "base.html" %}

{% block title %}{{ defeat.boss_name if defeat else 'è¨ä¼è©³ç´°' }} - è¨ä¼ #{{ defeat_id }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <a href="/" class="btn btn-secondary mb-3">â† å±¥æ­´ã«æˆ»ã‚‹</a>
        <h1 class="mb-3 text-white">
            {% if defeat %}
                {{ defeat.boss_name }} - è¨ä¼ #{{ defeat.id }}
            {% else %}
                è¨ä¼è©³ç´°
            {% endif %}
        </h1>
    </div>
</div>

{% if defeat %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ãƒœã‚¹æƒ…å ±</h5>
            </div>
            <div class="card-body">
                <p><strong>ãƒœã‚¹å:</strong> {{ defeat.boss_name }}</p>
                <p><strong>æœ€å¤§HP:</strong> {{ defeat.boss_max_hp|int|format_number }}</p>
                
                <div class="alert alert-success mb-0">
                    <strong>âœ… è¨ä¼å®Œäº†</strong><br>
                    <small>{{ defeat.defeated_at|to_jst }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">å‚åŠ çµ±è¨ˆ</h5>
            </div>
            <div class="card-body">
                <p><strong>å‚åŠ è€…æ•°:</strong> {{ defeat.total_participants }} äºº</p>
                <p><strong>ç·ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong> {{ defeat.total_damage|int|format_number }}</p>
                
                {% if participants %}
                <hr>
                <p class="mb-1"><strong>MVP:</strong></p>
                <p class="mb-0">
                    <strong>{{ participants[0].user_name }}</strong><br>
                    <span class="text-danger fs-4">{{ participants[0].total_damage|format_number }}</span> ãƒ€ãƒ¡ãƒ¼ã‚¸
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info">
                <h5 class="mb-0">ğŸ“œ æ”»æ’ƒå±¥æ­´</h5>
            </div>
            <div class="card-body">
                {% if attack_history %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th style="width: 80px;">#</th>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th class="text-end">ãƒ€ãƒ¡ãƒ¼ã‚¸</th>
                                <th>æ”»æ’ƒæ™‚åˆ»</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attack in attack_history %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong>{{ attack.user_name }}</strong>
                                    {% if attack.is_crit %}
                                        <span class="badge bg-warning">CRIT</span>
                                    {% endif %}
                                    {% if attack.is_miss %}
                                        <span class="badge bg-secondary">MISS</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if attack.is_miss %}
                                        <span class="text-muted">Miss!</span>
                                    {% else %}
                                        <strong class="text-danger">{{ attack.damage|format_number }}</strong>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ attack.attacked_at|to_jst_short }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">æ”»æ’ƒå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ‡ãƒ¼ã‚¿ä»¶æ•°: {{ attack_history|length if attack_history else 0 }}ï¼‰</p>
                <details style="margin-top: 10px;">
                    <summary style="color: #faa61a; cursor: pointer; font-size: 11px;">ãƒ‡ãƒãƒƒã‚°æƒ…å ±</summary>
                    <pre style="font-size: 10px;">attack_history type: {{ attack_history.__class__.__name__ if attack_history else 'None' }}
attack_history is None: {{ attack_history is none }}
attack_history length: {{ attack_history|length if attack_history else 0 }}
attack_history data: {{ attack_history|tojson(indent=2) }}

participants count: {{ participants|length if participants else 0 }}
{% if participants %}
First participant last_turn_log: {{ participants[0].last_turn_log|tojson(indent=2) if participants[0].last_turn_log else 'None' }}
{% endif %}
</pre>
                </details>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
